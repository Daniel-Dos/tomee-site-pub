<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
      <title>JPA Usage</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="./bootstrap.css" rel="stylesheet">
    <link href="./prettify.css" rel="stylesheet">
    <link href="./bootstrap-mods.css" rel="stylesheet">

    <style type="text/css">
        body {
          padding-top: 60px;
        }
        .sprite {
            display: inline-block;
            height: 20px;
            margin: 0 auto 4px;
            outline: medium none;
            text-indent: -999em;
            width: 24px;
            background-image: url('./images/sprites.png');
            background-repeat: no-repeat;
            overflow: hidden;
            cursor: pointer;
        }
        .edit-page {
            display: inline-block;
            height: 20px;
            margin: 0 auto 4px;
            outline: medium none;
            text-indent: -999em;
            width: 24px;
            background-image: url('./images/edit.png');
            background-repeat: no-repeat;
            overflow: hidden;
            cursor: pointer;
        }
        .fb-share {
            background-position: 0px -40px;
        }
        .gp-share {
            background-position: 0px 0px;
        }
        .tw-share {
            background-position: 0px -80px;
        }
    </style>

    <script type="text/javascript">
      function fbshare () {
          window.open(
                  "http://www.facebook.com/sharer/sharer.php?u="+document.URL,
                  'Share on Facebook',
                  'width=640,height=426');
      };
      function gpshare () {
          window.open(
                  "https://plus.google.com/share?url="+document.URL,
                  'Share on Google+',
                  'width=584,height=385');
      };
      function twshare () {
          window.open(
                  "https://twitter.com/intent/tweet?url="+document.URL+"&text=JPA Usage",
                  'Share on Twitter',
                  'width=800,height=526');
      };
    </script>

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="./images/favicon.ico">
    <link rel="apple-touch-icon" href="./images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./images/apple-touch-icon-114x114.png">

    <script src="./javascript/prettify.js" type="text/javascript"></script>
    <script src="./javascript/jquery-latest.js"></script>
    <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
    <script src="./javascript/common.js"></script>
    <script src="./javascript/prettyprint.js"></script>

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-2717626-1']);
      _gaq.push(['_setDomainName', 'apache.org']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>

  <body>

    <div class="topbar">
      <div class="fill">
        <div class="container">
          <a class="brand" href="./index.html">Apache TomEE</a>
          <ul class="nav">
            <li><a href="./index.html">Home</a></li>
            <li><a href="./downloads.html">Downloads</a></li>
            <li><a href="./documentation.html">Documentation</a></li>
            <li><a href="./support.html">Support</a></li>
          </ul>

            <!-- Google CSE Search Box Begins  -->
            <FORM class="pull-right" id="searchbox_010475492895890475512:_t4iqjrgx90" action="http://www.google.com/cse">
                <INPUT type="hidden" name="cx" value="010475492895890475512:_t4iqjrgx90">
                <INPUT type="hidden" name="cof" value="FORID:0">
                <INPUT name="q" type="text" placeholder="Search">
            </FORM>
            <!--<SCRIPT type="text/javascript" src="http://www.google.com/coop/cse/brand?form=searchbox_010475492895890475512:_t4iqjrgx90"></SCRIPT>-->
            <!-- Google CSE Search Box Ends -->
        </div>
      </div>
    </div>

    <div class="container">
    

<div class="page-header">
<small><a href="./index.html">Home</a></small><br>
<h1>JPA Usage

    <div style="float: right; position: relative; bottom: -10px; ">
        <a onclick="javascript:gpshare()" class="gp-share sprite" title="share on Google+">share [gp]</a>
        <a onclick="javascript:fbshare()" class="fb-share sprite" title="share on Facebook">share [fb]</a>
        <a onclick="javascript:twshare()" class="tw-share sprite" title="share on Twitter">share [tw]</a>
        <a data-toggle="modal" href="#edit" class="edit-page" title="Contribute to this Page">contribute</a>
    </div>
</h1>
</div>

<p><a name="JPAUsage-Thingstowatchoutfor"></a></p>

<h1>Things to watch out for</h1>

<p><a name="JPAUsage-Critical:Alwayssetjta-data-sourceandnon-jta-data-source"></a></p>

<h2>Critical: Always set jta-data-source and non-jta-data-source</h2>

<p>Always set the value of jta-data-source and non-jta-data-source in your
persistence.xml file.  Regardless if targeting your EntityManager usage for
transaction-type="RESOURCE_LOCAL" or transaction-type="TRANSACTION", it's
very difficult to guarantee one or the other will be the only one needed. 
Often times the JPA Provider itself will require both internally to do
various optimizations or other special features.  </p>

<ul>
<li>The <em>jta-data-source</em> should always have it's OpenEJB-specific
'<em>JtaManaged</em>' property set to '<em>true</em>'  (this is the default)</li>
<li>The <em>non-jta-data-source</em> should always have it's OpenEJB-specific
'<em>JtaManaged</em>' property set to '<em>false</em>'.</li>
</ul>

<p>See <a href="containers-and-resources.html">Containers and Resources</a>
 for how to configure 'JtaManaged' and a full list of <Resource> properties
for DataSources.</p>

<p><a name="JPAUsage-Bedetachaware"></a></p>

<h2>Be detach aware</h2>

<p>A warning for any new JPA user is by default all objects will detach at the
end of a transaction.  People typically discover this when the go to remove
or update an object they fetched previously and get an exception like "You
cannot perform operation delete on detached object".</p>

<p>All ejb methods start a transaction unless a) you <a href="transaction-annotations.html">configure them otherwise</a>
, or b) the caller already has a transaction in progress when it calls the
bean.  If you're in a test case or a servlet, it's most likely B that is
biting you.  You're asking an ejb for some persistent objects, it uses the
EntityManager in the scope of the transaction started around it's method
and returns some persistent objects, by the time you get them the
transaction has completed and now the objects are detached.</p>

<p><a name="JPAUsage-Solutions"></a></p>

<h3>Solutions</h3>

<ol>
<li>Call EntityManager.merge(..) inside the bean code to reattach your
object.</li>
<li>Use PersistenceContextType.EXTENDED as in '@PersistenceContext(unitName
= "movie-unit", type = PersistenceContextType.EXTENDED)' for EntityManager
refs instead of the default of PersistenceContextType.TRANSACTION.</li>
<li>If testing, use a technique to execute transactions in your test code. 
That's described here in <a href="unit-testing-transactions.html">Unit testing transactions</a></li>
</ol>




        <div id="edit" class="modal hide fade in" style="display: none; ">
            <div class="modal-header">
                <a class="close" data-dismiss="modal">x</a>

                <h3>Thank you for contributing to the documention!</h3>
            </div>
            <div class="modal-body">
                <h4>Any help with the documentation is greatly appreciated.</h4>
                <p>All edits are reviewed before going live, so feel free to do much more than fix typos or links.  If you see a page that could benefit from an entire rewrite, we'd be thrilled to review it.  Don't be surprised if we like it so much we ask you for help with other pages :)</p>
                <small>NOTICE: unless indicated otherwise on the pages in question, all editable content available from apache.org is presumed to be licensed under the Apache License (AL) version 2.0 and hence all submissions to apache.org treated as formal Contributions under the license terms.</small>
                <!--[if gt IE 6]>
                <h4>Internet Explorer Users</h4>
                <p>If you are not an Apache committer, click the Yes link and enter a <i>anonymous</i> for the username and leave the password empty</p>
                <![endif]-->

            </div>
            <div class="modal-footer">
                Do you have an Apache ID?
                <a href="javascript:void(location.href='https://cms.apache.org/redirect?uri='+escape(location.href))" class="btn">Yes</a>
                <a href="javascript:void(location.href='https://anonymous:@cms.apache.org/redirect?uri='+escape(location.href))" class="btn">No</a>
            </div>
        </div>
        <script src="./javascript/bootstrap-modal.js"></script>

      <footer>
        <p>
        Copyright &copy; 2011 The Apache Software Foundation, Licensed under the Apache License, Version 2.0.
        Apache and the Apache feather logo are trademarks of The Apache Software Foundation.
        </p>
      </footer>

    </div> <!-- /container -->

  </body>
</html>
