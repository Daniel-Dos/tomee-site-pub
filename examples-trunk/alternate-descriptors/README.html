<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
      <title>Alternate Descriptors</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="./../../bootstrap.css" rel="stylesheet">
    <link href="./../../prettify.css" rel="stylesheet">
    <link href="./../../bootstrap-mods.css" rel="stylesheet">

    <style type="text/css">
        body {
          padding-top: 60px;
        }
        .sprite {
            display: inline-block;
            height: 20px;
            margin: 0 auto 4px;
            outline: medium none;
            text-indent: -999em;
            width: 24px;
            background-image: url('./../../images/sprites.png');
            background-repeat: no-repeat;
            overflow: hidden;
            cursor: pointer;
        }
        .edit-page {
            display: inline-block;
            height: 20px;
            margin: 0 auto 4px;
            outline: medium none;
            text-indent: -999em;
            width: 24px;
            background-image: url('./../../images/edit.png');
            background-repeat: no-repeat;
            overflow: hidden;
            cursor: pointer;
        }
        .fb-share {
            background-position: 0px -40px;
        }
        .gp-share {
            background-position: 0px 0px;
        }
        .tw-share {
            background-position: 0px -80px;
        }
    </style>

    <script type="text/javascript">
      function fbshare () {
          window.open(
                  "http://www.facebook.com/sharer/sharer.php?u="+document.URL,
                  'Share on Facebook',
                  'width=640,height=426');
      };
      function gpshare () {
          window.open(
                  "https://plus.google.com/share?url="+document.URL,
                  'Share on Google+',
                  'width=584,height=385');
      };
      function twshare () {
          window.open(
                  "https://twitter.com/intent/tweet?url="+document.URL+"&text=Alternate Descriptors",
                  'Share on Twitter',
                  'width=800,height=526');
      };
    </script>

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="./../../images/favicon.ico">
    <link rel="apple-touch-icon" href="./../../images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./../../images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./../../images/apple-touch-icon-114x114.png">

    <script src="./../../javascript/prettify.js" type="text/javascript"></script>
    <script src="./../../javascript/jquery-latest.js"></script>
    <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
    <script src="./../../javascript/common.js"></script>
    <script src="./../../javascript/prettyprint.js"></script>

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-2717626-1']);
      _gaq.push(['_setDomainName', 'apache.org']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>

  <body>

    <div class="topbar">
      <div class="fill">
        <div class="container">
          <a class="brand" href="./../../index.html">Apache TomEE</a>
          <ul class="nav">
            <li><a href="./../../index.html">Home</a></li>
            <li><a href="./../../downloads.html">Downloads</a></li>
            <li><a href="./../../documentation.html">Documentation</a></li>
            <li><a href="./../../support.html">Support</a></li>
          </ul>

            <!-- Google CSE Search Box Begins  -->
            <FORM class="pull-right" id="searchbox_010475492895890475512:_t4iqjrgx90" action="http://www.google.com/cse">
                <INPUT type="hidden" name="cx" value="010475492895890475512:_t4iqjrgx90">
                <INPUT type="hidden" name="cof" value="FORID:0">
                <INPUT name="q" type="text" placeholder="Search">
            </FORM>
            <!--<SCRIPT type="text/javascript" src="http://www.google.com/coop/cse/brand?form=searchbox_010475492895890475512:_t4iqjrgx90"></SCRIPT>-->
            <!-- Google CSE Search Box Ends -->
        </div>
      </div>
    </div>

    <div class="container">
    

<div class="row">
    <div class="span8">
        <small><a href="./../../index.html">Home</a>&nbsp;&raquo&nbsp;<a href="./../../examples-trunk/">Examples Trunk</a>&nbsp;&raquo&nbsp;<a href="./../../examples-trunk/alternate-descriptors/">Alternate Descriptors</a></small><br>
    </div>
    <div class="span8">
    </div>
</div>
&nbsp;
<div class="page-header">
<h1>Alternate Descriptors

    <div style="float: right; position: relative; bottom: -10px; ">
        <a onclick="javascript:gpshare()" class="gp-share sprite" title="share on Google+">share [gp]</a>
        <a onclick="javascript:fbshare()" class="fb-share sprite" title="share on Facebook">share [fb]</a>
        <a onclick="javascript:twshare()" class="tw-share sprite" title="share on Twitter">share [tw]</a>
        <a data-toggle="modal" href="#edit" class="edit-page" title="Contribute to this Page">contribute</a>
    </div>
</h1>
</div>

<p>See the <a href="../../alternate-descriptors.html">Alternate Descriptors</a> page for the full details of how this feature works.</p>

<p>For our example we'll use the standard "moviefun" code which contains a <code>Movie</code> entity and <code>Movies</code> session bean.  To add a twist
for testing and demonstrate alternate descriptors, we will create an interceptor that will be used only in our test cases.</p>

<p>To add this to our application, we simply need a <code>test.ejb-jar.xml</code> in the same location that the regular <code>ejb-jar.xml</code> would be expected.</p>

<p>That gives us the following files in our project:</p>

<ul>
<li>src/main/resources/META-INF/ejb-jar.xml</li>
<li>src/main/resources/META-INF/persistence.xml</li>
<li>src/main/resources/META-INF/test.ejb-jar.xml</li>
</ul>

<h2>The test.ejb-jar.xml</h2>

<p>The normal <code>ejb-jar.xml</code> simply contains <code>&lt;ejb-jar/&gt;</code>, however the <code>test.ejb-jar.xml</code> we add an extra interceptor:</p>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;ejb-jar xmlns="http://java.sun.com/xml/ns/javaee"&gt;
  &lt;assembly-descriptor&gt;
    &lt;interceptor-binding&gt;
      &lt;ejb-name&gt;Movies&lt;/ejb-name&gt;
      &lt;interceptor-class&gt;org.superbiz.altdd.MoviesTest$Interceptor&lt;/interceptor-class&gt;
    &lt;/interceptor-binding&gt;
  &lt;/assembly-descriptor&gt;
&lt;/ejb-jar&gt;
</code></pre>

<h2>The TestCase</h2>

<p>To enable our <code>test.ejb-jar.xml</code> in the test case, we simply set the <code>openejb.altdd.prefix</code> property when creating the embedded <code>EJBContainer</code></p>

<pre><code> public class MoviesTest extends TestCase {

     @EJB
     private Movies movies;

     @Resource
     private UserTransaction userTransaction;

     @PersistenceContext
     private EntityManager entityManager;

     public void setUp() throws Exception {
         Properties p = new Properties();
         p.put("movieDatabase", "new://Resource?type=DataSource");
         p.put("movieDatabase.JdbcDriver", "org.hsqldb.jdbcDriver");
         p.put("movieDatabase.JdbcUrl", "jdbc:hsqldb:mem:moviedb");

         p.put("openejb.altdd.prefix", "test");

         EJBContainer.createEJBContainer(p).getContext().bind("inject", this);
     }

     public void test() throws Exception {

         userTransaction.begin();

         try {
             entityManager.persist(new Movie("Quentin Tarantino", "Reservoir Dogs", 1992));
             entityManager.persist(new Movie("Joel Coen", "Fargo", 1996));
             entityManager.persist(new Movie("Joel Coen", "The Big Lebowski", 1998));

             List&lt;Movie&gt; list = movies.getMovies();
             assertEquals("List.size()", 3, list.size());

             for (Movie movie : list) {
                 movies.deleteMovie(movie);
             }

             assertEquals("Movies.getMovies()", 0, movies.getMovies().size());

         } finally {
             try {
                 userTransaction.commit();
                 fail("Transaction should have been rolled back");
             } catch (RollbackException e) {
                 // Good, we don't want to clean up the db
             }
         }
     }

     public static class Interceptor {

         @Resource
         private SessionContext sessionContext;

         @AroundInvoke
         public Object invoke(InvocationContext context) throws Exception {

             sessionContext.setRollbackOnly();

             return context.proceed();
         }
     }
 }
</code></pre>

<p>As noted in <a href="../../alternate-descriptors.html">the documentation</a>, several prefixes can be used at once.</p>

<h1>Running</h1>

<pre><code>-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running org.superbiz.altdd.MoviesTest
Apache OpenEJB 4.0.0-beta-1    build: 20111002-04:06
http://openejb.apache.org/
INFO - openejb.home = /Users/dblevins/examples/alternate-descriptors
INFO - openejb.base = /Users/dblevins/examples/alternate-descriptors
INFO - Using 'javax.ejb.embeddable.EJBContainer=true'
INFO - Configuring Service(id=Default Security Service, type=SecurityService, provider-id=Default Security Service)
INFO - Configuring Service(id=Default Transaction Manager, type=TransactionManager, provider-id=Default Transaction Manager)
INFO - Configuring Service(id=movieDatabase, type=Resource, provider-id=Default JDBC Database)
INFO - Found EjbModule in classpath: /Users/dblevins/examples/alternate-descriptors/target/classes
INFO - Beginning load: /Users/dblevins/examples/alternate-descriptors/target/classes
INFO - AltDD ejb-jar.xml -&gt; file:/Users/dblevins/examples/alternate-descriptors/target/classes/META-INF/test.ejb-jar.xml
INFO - Configuring enterprise application: /Users/dblevins/examples/alternate-descriptors
WARN - Method 'lookup' is not available for 'javax.annotation.Resource'. Probably using an older Runtime.
INFO - Configuring Service(id=Default Stateful Container, type=Container, provider-id=Default Stateful Container)
INFO - Auto-creating a container for bean Movies: Container(type=STATEFUL, id=Default Stateful Container)
INFO - Configuring Service(id=Default Managed Container, type=Container, provider-id=Default Managed Container)
INFO - Auto-creating a container for bean org.superbiz.altdd.MoviesTest: Container(type=MANAGED, id=Default Managed Container)
INFO - Configuring PersistenceUnit(name=movie-unit)
INFO - Auto-creating a Resource with id 'movieDatabaseNonJta' of type 'DataSource for 'movie-unit'.
INFO - Configuring Service(id=movieDatabaseNonJta, type=Resource, provider-id=movieDatabase)
INFO - Adjusting PersistenceUnit movie-unit &lt;non-jta-data-source&gt; to Resource ID 'movieDatabaseNonJta' from 'movieDatabaseUnmanaged'
INFO - Enterprise application "/Users/dblevins/examples/alternate-descriptors" loaded.
INFO - Assembling app: /Users/dblevins/examples/alternate-descriptors
INFO - PersistenceUnit(name=movie-unit, provider=org.apache.openjpa.persistence.PersistenceProviderImpl) - provider time 411ms
INFO - Jndi(name="java:global/alternate-descriptors/Movies!org.superbiz.altdd.Movies")
INFO - Jndi(name="java:global/alternate-descriptors/Movies")
INFO - Jndi(name="java:global/EjbModule1893321675/org.superbiz.altdd.MoviesTest!org.superbiz.altdd.MoviesTest")
INFO - Jndi(name="java:global/EjbModule1893321675/org.superbiz.altdd.MoviesTest")
INFO - Created Ejb(deployment-id=Movies, ejb-name=Movies, container=Default Stateful Container)
INFO - Created Ejb(deployment-id=org.superbiz.altdd.MoviesTest, ejb-name=org.superbiz.altdd.MoviesTest, container=Default Managed Container)
INFO - Started Ejb(deployment-id=Movies, ejb-name=Movies, container=Default Stateful Container)
INFO - Started Ejb(deployment-id=org.superbiz.altdd.MoviesTest, ejb-name=org.superbiz.altdd.MoviesTest, container=Default Managed Container)
INFO - Deployed Application(path=/Users/dblevins/examples/alternate-descriptors)
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 2.569 sec

Results :

Tests run: 1, Failures: 0, Errors: 0, Skipped: 0
</code></pre>

<h1>Warning on Tooling</h1>

<p>If you split your descriptors into separate directories, this support will not work.  Specifically, this will not work:</p>

<ul>
<li>src/main/resources/META-INF/ejb-jar.xml</li>
<li>src/main/resources/META-INF/persistence.xml</li>
<li>src/<strong>test</strong>/resources/META-INF/test.ejb-jar.xml</li>
</ul>

<p>This support is <strong>not</strong> aware of any Maven, Gradle, Ant, IntelliJ, NetBeans, Eclipse or other settings.</p>


<div class="page-header">&nbsp;</div>
<h4>APIs Used</h4>
<ul><li><a href="http://docs.oracle.com/javaee/6/api/javax/annotation/Resource.html">javax.annotation.Resource</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/ejb/EJB.html">javax.ejb.EJB</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/ejb/SessionContext.html">javax.ejb.SessionContext</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/ejb/Stateful.html">javax.ejb.Stateful</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/ejb/TransactionAttribute.html">javax.ejb.TransactionAttribute</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/ejb/TransactionAttributeType.html#MANDATORY">javax.ejb.TransactionAttributeType.MANDATORY</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/ejb/embeddable/EJBContainer.html">javax.ejb.embeddable.EJBContainer</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/interceptor/AroundInvoke.html">javax.interceptor.AroundInvoke</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/interceptor/InvocationContext.html">javax.interceptor.InvocationContext</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/persistence/Entity.html">javax.persistence.Entity</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/persistence/EntityManager.html">javax.persistence.EntityManager</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/persistence/PersistenceContext.html">javax.persistence.PersistenceContext</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/persistence/PersistenceContextType.html">javax.persistence.PersistenceContextType</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/persistence/Query.html">javax.persistence.Query</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/transaction/RollbackException.html">javax.transaction.RollbackException</a></li>
<li><a href="http://docs.oracle.com/javaee/6/api/javax/transaction/UserTransaction.html">javax.transaction.UserTransaction</a></li>
</ul>

<h3>Source</h3>
  <ul>
      <li>Apache <a href="http://svn.apache.org/repos/asf/tomee/tomee/trunk/examples/alternate-descriptors">alternate-descriptors</a></li>
      <li>Github <a href="https://github.com/apache/tomee/tree/trunk/examples/alternate-descriptors">alternate-descriptors</a></li>
  </ul>
<pre>
svn co http://svn.apache.org/repos/asf/tomee/tomee/trunk/examples/alternate-descriptors
cd alternate-descriptors
mvn clean install
</pre>


        <div id="edit" class="modal hide fade in" style="display: none; ">
            <div class="modal-header">
                <a class="close" data-dismiss="modal">x</a>

                <h3>Thank you for contributing to the documention!</h3>
            </div>
            <div class="modal-body">
                <h4>Any help with the documentation is greatly appreciated.</h4>
                <p>All edits are reviewed before going live, so feel free to do much more than fix typos or links.  If you see a page that could benefit from an entire rewrite, we'd be thrilled to review it.  Don't be surprised if we like it so much we ask you for help with other pages :)</p>
                <small>NOTICE: unless indicated otherwise on the pages in question, all editable content available from apache.org is presumed to be licensed under the Apache License (AL) version 2.0 and hence all submissions to apache.org treated as formal Contributions under the license terms.</small>
                <!--[if gt IE 6]>
                <h4>Internet Explorer Users</h4>
                <p>If you are not an Apache committer, click the Yes link and enter a <i>anonymous</i> for the username and leave the password empty</p>
                <![endif]-->

            </div>
            <div class="modal-footer">
                Do you have an Apache ID?
                <a href="javascript:void(location.href='https://cms.apache.org/redirect?uri='+escape(location.href))" class="btn">Yes</a>
                <a href="javascript:void(location.href='https://anonymous:@cms.apache.org/redirect?uri='+escape(location.href))" class="btn">No</a>
            </div>
        </div>
        <script src="./../../javascript/bootstrap-modal.js"></script>

      <footer>
        <p>
        Copyright &copy; 2011 The Apache Software Foundation, Licensed under the Apache License, Version 2.0.
        Apache and the Apache feather logo are trademarks of The Apache Software Foundation.
        </p>
      </footer>

    </div> <!-- /container -->

  </body>
</html>
